name: CI

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_data: |
            extends: default
            rules:
              line-length:
                max: 200
              document-start: disable
              truthy:
                check-keys: false

      - name: Validate Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: |
            **/*.md
            !node_modules/**
          config: |
            {
              "MD013": false,
              "MD033": false,
              "MD041": false
            }

      - name: Check spec file structure
        run: |
          echo "Checking specification files..."

          # Check TRACEABILITY.md exists
          if [ ! -f "specs/TRACEABILITY.md" ]; then
            echo "ERROR: specs/TRACEABILITY.md not found"
            exit 1
          fi

          # Check required directories
          for dir in specs/features specs/api specs/data specs/infra; do
            if [ ! -d "$dir" ]; then
              echo "WARNING: Directory $dir not found"
            fi
          done

          echo "Spec structure validation passed!"

      - name: Validate spec IDs
        run: |
          echo "Validating spec ID conventions..."

          # Check for proper spec ID format in filenames
          find specs -name "*.md" -type f | while read file; do
            basename=$(basename "$file" .md)
            # Skip TRACEABILITY.md
            if [ "$basename" = "TRACEABILITY" ]; then
              continue
            fi

            # Check if filename matches expected pattern (PREFIX-NNN)
            if ! echo "$basename" | grep -qE "^(FEAT|API|DATA|UI|SEC|PERF|INFRA|PLAN)-[0-9]{3}$"; then
              echo "WARNING: $file does not follow naming convention (PREFIX-NNN)"
            fi
          done

          echo "Spec ID validation completed!"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.validate.result }}" = "success" ]; then
            echo "✅ All validations passed!"
            exit 0
          else
            echo "❌ Some validations failed"
            exit 1
          fi
