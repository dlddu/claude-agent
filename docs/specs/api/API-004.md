# API-004: Cancel Execution

## Metadata
- **ID**: API-004
- **Created**: 2025-12-26
- **Status**: Approved

## Endpoint
- **Method**: POST
- **Path**: `/api/v1/executions/{id}/cancel`
- **Authentication**: Required (API Key or JWT)

## Description
실행 중인 Agent를 취소합니다. K8s Job을 삭제하고 상태를 CANCELLED로 변경합니다.

## Request

### Headers
| Header | Required | Description |
|--------|----------|-------------|
| Authorization | Yes | `Bearer {token}` or `ApiKey {key}` |
| Content-Type | Yes | `application/json` |

### Path Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| id | UUID | Yes | 실행 ID |

### Body
```json
{
  "reason": "string (optional) - 취소 사유"
}
```

## Response

### Success (200 OK)
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "CANCELLED",
  "jobName": "claude-agent-550e8400",
  "cancelledAt": "2025-12-26T10:05:00Z",
  "cancelReason": "User requested cancellation",
  "message": "Execution cancelled successfully"
}
```

### Error Codes
| Code | HTTP Status | Description |
|------|-------------|-------------|
| NOT_FOUND | 404 | 실행을 찾을 수 없음 |
| INVALID_STATE | 409 | 취소할 수 없는 상태 (이미 완료됨) |
| UNAUTHORIZED | 401 | 인증 실패 |
| FORBIDDEN | 403 | 권한 없음 |
| INTERNAL_ERROR | 500 | 서버 내부 오류 |

### Error Response Example
```json
{
  "error": {
    "code": "INVALID_STATE",
    "message": "Cannot cancel execution in COMPLETED state",
    "details": {
      "currentStatus": "COMPLETED",
      "allowedStatuses": ["PENDING", "RUNNING"]
    }
  },
  "requestId": "req-123456"
}
```

## State Transitions

취소 가능한 상태:
- PENDING → CANCELLED
- RUNNING → CANCELLED

취소 불가능한 상태:
- COMPLETED
- FAILED
- CANCELLED

## Cancellation Process

1. 실행 상태 확인 (PENDING 또는 RUNNING)
2. K8s Job 삭제 요청
3. DB 상태를 CANCELLED로 업데이트
4. 상태 전환 이력 기록
5. 관련 Pod 정리 대기 (비동기)

## Related Specs
- FEAT-002
- API-002

---

## Change History

| Date | Author | Description |
|------|--------|-------------|
| 2025-12-26 | System | Initial creation |
